{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>EcoVerse AI Assistant</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="EcoVerse AI Assistant: Get insights on waste, energy, and sustainability." />
  <link rel="canonical" href="./ai_assist.html" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<style>

.ai-container {
  display: flex;
  height: 100vh;
}

/* Chat pane */
.chat-pane {
  flex: 3;
  display: flex;
  flex-direction: column;
  background: #ffffff;
  border-right: 1px solid #e5e7eb;
}

.chat-messages {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
}

.message {
  max-width: 70%;
  margin-bottom: 12px;
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 14px;
}

.user {
  background: #dcfce7;
  align-self: flex-end;
}

.bot {
  background: #f1f5f9;
  align-self: flex-start;
}

/* Input */
.chat-input {
  display: flex;
  padding: 12px;
  border-top: 1px solid #e5e7eb;
  gap: 8px;
}

.chat-input input[type="text"] {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
}

.chat-input button {
  padding: 10px 14px;
  border: none;
  border-radius: 8px;
  background: #16a34a;
  color: white;
  cursor: pointer;
}

.attach-btn {
  font-size: 18px;
  cursor: pointer;
}

/* History */
.history-pane {
  flex: 1;
  background: #f9fafb;
  padding: 16px;
}

.history-pane h4 {
  margin-bottom: 12px;
}

.history-item {
  padding: 10px;
  border-radius: 8px;
  background: #ffffff;
  margin-bottom: 8px;
  cursor: pointer;
}

.history-item.active {
  background: #dcfce7;
}


/* ---------- Mobile Responsiveness ---------- */
@media (max-width: 768px) {

  .ai-container {
    flex-direction: column;
    height: 100dvh; /* better than 100vh on mobile */
  }

  /* Chat pane takes full screen */
  .chat-pane {
    flex: 1;
    border-right: none;
  }

  /* Hide history by default (can be toggled later if needed) */
  .history-pane {
    display: flex;
    flex-direction: row;
    overflow-x: auto;
    gap: 8px;
    padding: 8px;
    border-top: 1px solid #e5e7eb;
  }

  .history-item {
    min-width: 140px;
    white-space: nowrap;
  }


  /* Messages */
  .chat-messages {
    padding: 12px;
  }

  .message {
    max-width: 90%;
    font-size: 15px;
    padding: 10px 12px;
  }

  /* Input area */
  .chat-input {
    padding: 10px;
    gap: 6px;
  }

  .chat-input input[type="text"] {
    font-size: 16px; /* prevents iOS zoom */
    padding: 12px;
  }

  .chat-input button {
    padding: 12px 14px;
    font-size: 14px;
  }

  .attach-btn {
    font-size: 20px;
  }
}


</style>


<body>




<div class="ai-container">

{% include 'sidebar.html' %}

  <!-- Chat Area -->
  <div class="chat-pane">
    <div id="chatMessages" class="chat-messages"></div>

    <form id="chatForm" class="chat-input">
      <label for="fileInput" class="attach-btn">ðŸ“Ž</label>
      <input type="file" id="fileInput" hidden>

      <input type="text" id="userInput" placeholder="Ask about waste, tokens, energy..." required>
      <button type="submit">Send</button>
    </form>
  </div>

  <!-- Conversation History -->
  <div class="history-pane">
    <h4>Conversations</h4>
    <ul id="conversationList">
      <li class="history-item active">Current Session</li>
    </ul>
  </div>

</div>

<script>

    const chatForm = document.getElementById("chatForm");
    const chatMessages = document.getElementById("chatMessages");
    const userInput = document.getElementById("userInput");
    const fileInput = document.getElementById("fileInput");

    function addMessage(text, sender) {
    const div = document.createElement("div");
    div.className = `message ${sender}`;
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const message = userInput.value;
    if (!message) return;

    addMessage(message, "user");
    userInput.value = "";

    const formData = new FormData();
    formData.append("message", message);

    if (fileInput.files.length > 0) {
        formData.append("file", fileInput.files[0]);
    }

    const response = await fetch("/chatbot/", {
        method: "POST",
        headers: {
        "X-CSRFToken": getCSRFToken()
        },
        body: formData
    });

    const data = await response.json();
    addMessage(data.response, "bot");
    });

    function getCSRFToken() {
    return document.cookie
        .split("; ")
        .find(row => row.startsWith("csrftoken"))
        ?.split("=")[1];
    }


</script>

<script src="{% static 'js/ai_assistant.js' %}"></script>
</body>
</html>
